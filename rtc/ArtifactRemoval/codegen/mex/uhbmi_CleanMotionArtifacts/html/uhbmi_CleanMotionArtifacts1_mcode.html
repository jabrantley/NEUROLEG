<!-- saved from url=(0014)about:internet -->
<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1">  1</a></span><span class="line"><span class="keyword">function</span> <span class="var type1" id="S2T1U3">outData</span> = uhbmi_CleanMotionArtifacts(<span class="var type1" id="S3T1U6">inDataEEG</span>, <span class="var type1" id="S4T2U7">inDataRef</span>, <span class="var type1" id="S5T3U8">gamma</span>, <span class="var type1" id="S6T3U9">q</span>, <span class="var type1" id="S7T3U10">numTaps</span>, <span class="var type1" id="S8T4U11">A</span>, <span class="var type1" id="S9T5U12">B</span>, <span class="var type1" id="S10T6U13">C</span>, <span class="var type1" id="S11T7U14">D</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2">  2</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3">  3</a></span><span class="line"><span class="comment">%#codegen</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4">  4</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5">  5</a></span><span class="line"><span class="comment">% This code is based on "VHINF_v004.m"</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6">  6</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7">  7</a></span><span class="line"><span class="comment">%% Persistent Variables</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8">  8</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9">  9</a></span><span class="line"><span class="keyword">persistent</span> <span class="var type1" id="S12T8U16">isFirstLoop</span> <span class="var type1" id="S13T9U17">XnnBPFilter</span> <span class="var type1" id="S14T10U18">refBuffer</span> <span class="var type1" id="S15T11U19">PtHinf</span> <span class="var type1" id="S16T12U20">whHinf</span> <span class="var type1" id="S17T13U21">cleanData</span> <span class="var type1" id="S18T14U22">REF</span> <span class="var type1" id="S19T3U23">isLinear</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10"> 10</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11"> 11</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12"> 12</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13"> 13</a></span><span class="line"><span class="comment">%% initializations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14"> 14</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15"> 15</a></span><span class="line"><span class="comment">% From Input</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16"> 16</a></span><span class="line"><span class="mxinfo " id="T3:U19"><span class="var type1" id="S20T3U26">numRefChannels</span>  = <span class="mxinfo " id="T3:U21">size(<span class="var type1" id="S4T2U29">inDataRef</span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17"> 17</a></span><span class="line"><span class="mxinfo " id="T3:U23"><span class="var type1" id="S22T3U33">numDecomp</span>       = <span class="mxinfo " id="T3:U25">size(<span class="var type1" id="S8T4U36">A</span>,3)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18"> 18</a></span><span class="line"><span class="mxinfo " id="T3:U27"><span class="var type1" id="S23T3U40">butterOrder</span>     = <span class="mxinfo " id="T3:U29">size(<span class="var type1" id="S8T4U44">A</span>,1)/2</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19"> 19</a></span><span class="line"><span class="mxinfo " id="T3:U31"><span class="var type1" id="S24T3U49">numDataChannels</span> = <span class="mxinfo " id="T3:U33">size(<span class="var type1" id="S3T1U52">inDataEEG</span>,2)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20"> 20</a></span><span class="line"><span class="mxinfo " id="T3:U35"><span class="var type1" id="S25T3U56">numTimePoints</span>   = <span class="mxinfo " id="T3:U37">size(<span class="var type1" id="S4T2U59">inDataRef</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21"> 21</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22"> 22</a></span><span class="line"><span class="comment">% Other</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23"> 23</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T8:U39"><span class="var type1" id="S7T3U64">numTaps</span>&gt;<span class="mxinfo " id="T3:U41">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24"> 24</a></span><span class="line">    <span class="mxinfo " id="T3:U42"><span class="var type1" id="S26T3U68">numHinfRefs</span> = <span class="mxinfo " id="T3:U44"><span class="var type1" id="S20T3U70">numRefChannels</span>*(<span class="mxinfo " id="T3:U46"><span class="mxinfo " id="T3:U47">nchoosek(<span class="var type1" id="S7T3U75">numTaps</span>,2)</span> + <span class="mxinfo " id="T3:U49"><span class="mxinfo " id="T3:U50">2</span>*<span class="var type1" id="S7T3U79">numTaps</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25"> 25</a></span><span class="line">    <span class="mxinfo " id="T3:U52"><span class="var type1" id="S19T3U82">isLinear</span> = <span class="mxinfo " id="T3:U54">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26"> 26</a></span><span class="line"><span class="keyword">elseif</span> <span class="mxinfo " id="T8:U55"><span class="var type1" id="S7T3U86">numTaps</span> == <span class="mxinfo " id="T3:U57">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27"> 27</a></span><span class="line">    <span class="mxinfo " id="T3:U58"><span class="var type1" id="S26T3U90">numHinfRefs</span> = <span class="mxinfo " id="T3:U60"><span class="var type1" id="S20T3U92">numRefChannels</span>*(<span class="mxinfo " id="T3:U62"><span class="mxinfo " id="T3:U63">nchoosek(<span class="var type1" id="S7T3U97">numTaps</span>,1)</span> + <span class="mxinfo " id="T3:U65"><span class="mxinfo " id="T3:U66">1</span>*<span class="var type1" id="S7T3U101">numTaps</span></span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28"> 28</a></span><span class="line">    <span class="mxinfo " id="T3:U68"><span class="var type1" id="S19T3U104">isLinear</span> = <span class="mxinfo " id="T3:U70">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29"> 29</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30"> 30</a></span><span class="line">    <span class="mxinfo " id="T3:U71"><span class="var type1" id="S26T3U109">numHinfRefs</span> = <span class="var type1" id="S20T3U110">numRefChannels</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31"> 31</a></span><span class="line">    <span class="mxinfo " id="T3:U74"><span class="var type1" id="S19T3U113">isLinear</span> = <span class="mxinfo " id="T3:U76">1</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32"> 32</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33"> 33</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34"> 34</a></span><span class="line"><span class="keyword">if</span> <span class="mxinfo " id="T8:U77">isempty(<span class="var type0" id="S12T0U119">isFirstLoop</span>)</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35"> 35</a></span><span class="line">    <span class="mxinfo " id="T8:U78"><span class="var type1" id="S12T8U122">isFirstLoop</span> = <span class="mxinfo " id="T8:U80">true</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36"> 36</a></span><span class="line">    <span class="mxinfo " id="T9:U81"><span class="var type1" id="S13T9U127">XnnBPFilter</span>    = <span class="mxinfo " id="T9:U83">zeros(<span class="mxinfo " id="T3:U84">2*<span class="var type1" id="S23T3U132">butterOrder</span></span>,<span class="var type1" id="S20T3U133">numRefChannels</span>,<span class="var type1" id="S22T3U134">numDecomp</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37"> 37</a></span><span class="line">    <span class="mxinfo " id="T13:U88"><span class="var type1" id="S17T13U137">cleanData</span>      = <span class="mxinfo " id="T13:U90">zeros(<span class="mxinfo " id="T3:U91">size(<span class="var type1" id="S3T1U142">inDataEEG</span>,1)</span>,<span class="mxinfo " id="T3:U93">size(<span class="var type1" id="S3T1U146">inDataEEG</span>,2)</span>,<span class="var type1" id="S22T3U148">numDecomp</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38"> 38</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T8:U96">~<span class="var type1" id="S19T3U152">isLinear</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39"> 39</a></span><span class="line">        <span class="mxinfo " id="T10:U98"><span class="var type1" id="S14T10U155">refBuffer</span>  = <span class="mxinfo " id="T15:U100">zeros(<span class="var type1" id="S20T3U158">numRefChannels</span>,<span class="var type1" id="S7T3U159">numTaps</span>,<span class="var type1" id="S22T3U160">numDecomp</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40"> 40</a></span><span class="line">        <span class="autoExtrinsicFcn" id="F526N4:B163">disp</span>(<span class="string">'UHBMI: Non-Linear De-Noising'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41"> 41</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42"> 42</a></span><span class="line">        <span class="mxinfo " id="T10:U104"><span class="var type1" id="S14T10U168">refBuffer</span>  = <span class="mxinfo " id="T16:U106">zeros(<span class="var type1" id="S20T3U171">numRefChannels</span>,1)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43"> 43</a></span><span class="line">        <span class="autoExtrinsicFcn" id="F527N4:B175">disp</span>(<span class="string">'UHBMI: Linear De-Noising'</span>)</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44"> 44</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45"> 45</a></span><span class="line">    <span class="mxinfo " id="T11:U108"><span class="var type1" id="S15T11U179">PtHinf</span>         = <span class="mxinfo " id="T11:U110">zeros(<span class="var type1" id="S26T3U182">numHinfRefs</span>,<span class="var type1" id="S26T3U183">numHinfRefs</span>,<span class="var type1" id="S22T3U184">numDecomp</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46"> 46</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S32T3U187">i</span>=<span class="mxinfo " id="T3:U115">1</span>:<span class="var type1" id="S22T3U190">numDecomp</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47"> 47</a></span><span class="line">        <span class="mxinfo " id="T17:U117"><span class="mxinfo " id="T17:U118"><span class="var type1" id="S15T11U194">PtHinf</span>(<span class="mxinfo " id="T18:U120">:</span>,<span class="mxinfo " id="T18:U121">:</span>,<span class="var type1" id="S32T3U197">i</span>)</span>  = <span class="mxinfo " id="T17:U123"><span class="mxinfo " id="T3:U124">0.1</span>*<span class="mxinfo " id="T17:U125">eye(<span class="var type1" id="S26T3U202">numHinfRefs</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48"> 48</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49"> 49</a></span><span class="line">    <span class="mxinfo " id="T12:U127"><span class="var type1" id="S16T12U205">whHinf</span>         = <span class="mxinfo " id="T12:U129"><span class="mxinfo " id="T3:U130">0</span>+<span class="mxinfo " id="T12:U131">zeros(<span class="var type1" id="S26T3U210">numHinfRefs</span>,<span class="var type1" id="S24T3U211">numDataChannels</span>,<span class="var type1" id="S22T3U212">numDecomp</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50"> 50</a></span><span class="line">    <span class="mxinfo " id="T14:U135"><span class="var type1" id="S18T14U215">REF</span>            = <span class="mxinfo " id="T14:U137">zeros(<span class="mxinfo " id="T3:U138">size(<span class="var type1" id="S4T2U220">inDataRef</span>,1)</span>,<span class="mxinfo " id="T3:U140">size(<span class="var type1" id="S4T2U224">inDataRef</span>,2)</span>,<span class="var type1" id="S22T3U226">numDecomp</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51"> 51</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S32T3U229">i</span>=<span class="mxinfo " id="T3:U144">1</span>:<span class="var type1" id="S22T3U232">numDecomp</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52"> 52</a></span><span class="line">        <span class="comment">%cleanData{i} = zeros(size(inDataEEG));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53"> 53</a></span><span class="line">        <span class="comment">%refBuffer{i} = zeros(numRefChannels,numTaps);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54"> 54</a></span><span class="line">        <span class="comment">%PtHinf{i}    = 0.1*eye(numHinfRefs);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55"> 55</a></span><span class="line">        <span class="comment">%whHinf{i}    = 0+zeros(numHinfRefs,numDataChannels);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56"> 56</a></span><span class="line">        <span class="comment">%REF{i}       = zeros(size(inDataRef));</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57"> 57</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58"> 58</a></span><span class="line"><span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59"> 59</a></span><span class="line">    <span class="mxinfo " id="T8:U146"><span class="var type1" id="S12T8U236">isFirstLoop</span> = <span class="mxinfo " id="T8:U148">false</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60"> 60</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61"> 61</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62"> 62</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63"> 63</a></span><span class="line"><span class="comment">%% decompose reference into frequencies</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64"> 64</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65"> 65</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66"> 66</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S32T3U241">i</span>=<span class="mxinfo " id="T3:U150">1</span>:<span class="var type1" id="S22T3U244">numDecomp</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67"> 67</a></span><span class="line">    [<span class="mxinfo " id="T2:U152"><span class="var type1" id="S18T14U249">REF</span>(<span class="mxinfo " id="T19:U154">:</span>,<span class="mxinfo " id="T20:U155">:</span>,<span class="var type1" id="S32T3U252">i</span>)</span> , <span class="mxinfo " id="T21:U157"><span class="var type1" id="S13T9U254">XnnBPFilter</span>(<span class="mxinfo " id="T22:U159">:</span>,<span class="mxinfo " id="T20:U160">:</span>,<span class="var type1" id="S32T3U257">i</span>)</span>] = <span class="fcn" id="F121N10:B259">uhbmi_StateSpaceFilter</span>( <span class="var type1" id="S4T2U260">inDataRef</span>, <span class="mxinfo " id="T23:U163"><span class="var type1" id="S8T4U262">A</span>(<span class="mxinfo " id="T22:U165">:</span>,<span class="mxinfo " id="T22:U166">:</span>,<span class="var type1" id="S32T3U265">i</span>)</span>,<span class="mxinfo " id="T24:U168"><span class="var type1" id="S9T5U267">B</span>(<span class="mxinfo " id="T22:U170">:</span>,<span class="mxinfo " id="T19:U171">:</span>,<span class="var type1" id="S32T3U270">i</span>)</span>,<span class="mxinfo " id="T25:U173"><span class="var type1" id="S10T6U272">C</span>(<span class="mxinfo " id="T19:U175">:</span>,<span class="mxinfo " id="T22:U176">:</span>,<span class="var type1" id="S32T3U275">i</span>)</span>,<span class="mxinfo " id="T3:U178"><span class="var type1" id="S11T7U277">D</span>(<span class="mxinfo " id="T19:U180">:</span>,<span class="mxinfo " id="T19:U181">:</span>,<span class="var type1" id="S32T3U280">i</span>)</span>, <span class="mxinfo " id="T21:U183"><span class="var type1" id="S13T9U282">XnnBPFilter</span>(<span class="mxinfo " id="T22:U185">:</span>,<span class="mxinfo " id="T20:U186">:</span>,<span class="var type1" id="S32T3U285">i</span>)</span> );</span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68"> 68</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69"> 69</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70"> 70</a></span><span class="line"><span class="comment">%% Form Volterra Representation of reference and Clean using Hinf</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71"> 71</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72"> 72</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73"> 73</a></span><span class="line"><span class="keyword">for</span> <span class="var type1" id="S36T3U288">J</span> = <span class="mxinfo " id="T3:U189">1</span>:<span class="var type1" id="S22T3U291">numDecomp</span> <span class="comment">% for each target frequency</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74"> 74</a></span><span class="line">    <span class="keyword">if</span> <span class="mxinfo " id="T8:U191"><span class="var type1" id="S36T3U295">J</span>==<span class="mxinfo " id="T3:U193">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75"> 75</a></span><span class="line">        <span class="mxinfo " id="T1:U194"><span class="var type1" id="S37T1U299">indat</span> = <span class="var type1" id="S3T1U300">inDataEEG</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76"> 76</a></span><span class="line">    <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77"> 77</a></span><span class="line">        <span class="mxinfo " id="T1:U197"><span class="var type1" id="S37T1U304">indat</span> = <span class="mxinfo " id="T1:U199"><span class="var type1" id="S17T13U306">cleanData</span>(<span class="mxinfo " id="T19:U201">:</span>,<span class="mxinfo " id="T26:U202">:</span>,<span class="mxinfo " id="T3:U203"><span class="var type1" id="S36T3U310">J</span>-<span class="mxinfo " id="T3:U205">1</span></span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78"> 78</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79"> 79</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80"> 80</a></span><span class="line">    <span class="keyword">for</span> <span class="var type1" id="S32T3U314">i</span>=<span class="mxinfo " id="T3:U207">1:<span class="var type1" id="S25T3U317">numTimePoints</span></span> <span class="comment">% for each time point</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81"> 81</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82"> 82</a></span><span class="line">        <span class="comment">%% Volterra Expansion of reference data</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83"> 83</a></span><span class="line">        <span class="keyword">if</span> <span class="mxinfo " id="T8:U209">~<span class="var type1" id="S19T3U321">isLinear</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84"> 84</a></span><span class="line">            <span class="mxinfo " id="T27:U211"><span class="mxinfo " id="T27:U212"><span class="var type1" id="S14T10U325">refBuffer</span>(<span class="mxinfo " id="T20:U214">:</span>,<span class="mxinfo " id="T18:U215">:</span>,<span class="var type1" id="S36T3U328">J</span>)</span>=<span class="mxinfo " id="T27:U217">[<span class="mxinfo " id="T16:U218"><span class="mxinfo " id="T2:U219"><span class="var type1" id="S18T14U333">REF</span>(<span class="var type1" id="S32T3U334">i</span>,<span class="mxinfo " id="T20:U222">:</span>,<span class="var type1" id="S36T3U336">J</span>)</span>'</span> <span class="mxinfo " id="T27:U224"><span class="var type1" id="S14T10U338">refBuffer</span>(<span class="mxinfo " id="T20:U226">:</span>,<span class="mxinfo " id="T28:U227"><span class="mxinfo " id="T3:U228">1</span>:<span class="mxinfo " id="T3:U229"><span class="mxinfo " id="T3:U230">end</span>-<span class="mxinfo " id="T3:U231">1</span></span></span>,<span class="var type1" id="S36T3U346">J</span>)</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85"> 85</a></span><span class="line">            <span class="keyword">if</span> <span class="mxinfo " id="T8:U233"><span class="var type1" id="S7T3U350">numTaps</span>&gt;<span class="mxinfo " id="T3:U235">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86"> 86</a></span><span class="line">                <span class="mxinfo " id="T29:U236"><span class="var type1" id="S39T29U354">volterraCrossTerms</span> = <span class="mxinfo " id="T27:U238">zeros(<span class="var type1" id="S20T3U357">numRefChannels</span>,<span class="mxinfo " id="T3:U240">nchoosek(<span class="var type1" id="S7T3U360">numTaps</span>,2)</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87"> 87</a></span><span class="line">                <span class="comment">%Generating Cross-terms</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,88" id="srcline88"> 88</a></span><span class="line">                <span class="mxinfo " id="T3:U242"><span class="var type1" id="S40T3U364">numLoop</span> = <span class="mxinfo " id="T3:U244">0</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,89" id="srcline89"> 89</a></span><span class="line">                <span class="keyword">for</span> <span class="var type1" id="S41T3U368">k</span>=<span class="mxinfo " id="T3:U246">1</span>:<span class="mxinfo " id="T3:U247"><span class="var type1" id="S7T3U372">numTaps</span>-<span class="mxinfo " id="T3:U249">1</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,90" id="srcline90"> 90</a></span><span class="line">                    <span class="keyword">for</span> <span class="var type1" id="S42T3U376">j</span>=<span class="mxinfo " id="T3:U251">1</span>:<span class="mxinfo " id="T3:U252"><span class="var type1" id="S7T3U380">numTaps</span>-<span class="var type1" id="S41T3U381">k</span></span></span></span>
<span class="srcline"><span class="lineno"><a href="1,91" id="srcline91"> 91</a></span><span class="line">                        <span class="mxinfo " id="T3:U255"><span class="var type1" id="S40T3U384">numLoop</span>=<span class="mxinfo " id="T3:U257"><span class="var type1" id="S40T3U386">numLoop</span>+<span class="mxinfo " id="T3:U259">1</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,92" id="srcline92"> 92</a></span><span class="line">                        <span class="mxinfo " id="T30:U260"><span class="mxinfo " id="T30:U261"><span class="var type1" id="S39T29U391">volterraCrossTerms</span>(<span class="mxinfo " id="T31:U263">:</span>,<span class="var type1" id="S40T3U393">numLoop</span>)</span> = <span class="mxinfo " id="T16:U265"><span class="mxinfo " id="T16:U266"><span class="var type1" id="S14T10U396">refBuffer</span>(<span class="mxinfo " id="T20:U268">:</span>,<span class="var type1" id="S42T3U398">j</span>,<span class="var type1" id="S36T3U399">J</span>)</span>.*<span class="mxinfo " id="T16:U271"><span class="var type1" id="S14T10U401">refBuffer</span>(<span class="mxinfo " id="T20:U273">:</span>,<span class="mxinfo " id="T3:U274"><span class="var type1" id="S42T3U404">j</span>+<span class="var type1" id="S41T3U405">k</span></span>,<span class="var type1" id="S36T3U406">J</span>)</span></span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,93" id="srcline93"> 93</a></span><span class="line">                    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,94" id="srcline94"> 94</a></span><span class="line">                <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,95" id="srcline95"> 95</a></span><span class="line">            <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,96" id="srcline96"> 96</a></span><span class="line">                <span class="mxinfo " id="T29:U278"><span class="var type1" id="S39T29U410">volterraCrossTerms</span> = <span class="mxinfo " id="T32:U280">[]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,97" id="srcline97"> 97</a></span><span class="line">            <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,98" id="srcline98"> 98</a></span><span class="line">            <span class="comment">% Final Contents of after Volterra Expansion</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,99" id="srcline99"> 99</a></span><span class="line">            <span class="mxinfo " id="T29:U281"><span class="var type1" id="S43T29U415">volterraRef</span> = <span class="mxinfo " id="T29:U283">[<span class="mxinfo " id="T27:U284"><span class="var type1" id="S14T10U419">refBuffer</span>(<span class="mxinfo " id="T20:U286">:</span>,<span class="mxinfo " id="T18:U287">:</span>,<span class="var type1" id="S36T3U422">J</span>)</span>, <span class="mxinfo " id="T27:U289"><span class="mxinfo " id="T27:U290"><span class="var type1" id="S14T10U425">refBuffer</span>(<span class="mxinfo " id="T20:U292">:</span>,<span class="mxinfo " id="T18:U293">:</span>,<span class="var type1" id="S36T3U428">J</span>)</span>.^2</span>, <span class="var type1" id="S39T29U430">volterraCrossTerms</span>]</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,100" id="srcline100">100</a></span><span class="line">        <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,101" id="srcline101">101</a></span><span class="line">            <span class="mxinfo " id="T29:U296"><span class="var type1" id="S43T29U434">volterraRef</span> = <span class="mxinfo " id="T16:U298"><span class="var type1" id="S4T2U436">inDataRef</span>'</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,102" id="srcline102">102</a></span><span class="line">        <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,103" id="srcline103">103</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,104" id="srcline104">104</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,105" id="srcline105">105</a></span><span class="line">        <span class="comment">%% HINF FILTERING</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,106" id="srcline106">106</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,107" id="srcline107">107</a></span><span class="line">        [<span class="mxinfo " id="T1:U300"><span class="var type1" id="S17T13U441">cleanData</span>(<span class="var type1" id="S32T3U442">i</span>,<span class="mxinfo " id="T26:U303">:</span>,<span class="var type1" id="S36T3U444">J</span>)</span>,<span class="mxinfo " id="T1:U305">~</span>,<span class="mxinfo " id="T17:U306"><span class="var type1" id="S15T11U447">PtHinf</span>(<span class="mxinfo " id="T18:U308">:</span>,<span class="mxinfo " id="T18:U309">:</span>,<span class="var type1" id="S36T3U450">J</span>)</span>,<span class="mxinfo " id="T33:U311"><span class="var type1" id="S16T12U452">whHinf</span>(<span class="mxinfo " id="T18:U313">:</span>,<span class="mxinfo " id="T26:U314">:</span>,<span class="var type1" id="S36T3U455">J</span>)</span>]   = <span class="fcn" id="F523N9:B457">uhbmi_HinfFilter</span>(<span class="mxinfo " id="T1:U316"><span class="var type1" id="S37T1U459">indat</span>(<span class="var type1" id="S32T3U460">i</span>,<span class="mxinfo " id="T26:U319">:</span>)</span>, <span class="mxinfo " id="T28:U320"><span class="mxinfo " id="T34:U321"><span class="var type1" id="S43T29U464">volterraRef</span>(:)</span>'</span>, <span class="var type1" id="S5T3U466">gamma</span>, <span class="mxinfo " id="T17:U324"><span class="var type1" id="S15T11U468">PtHinf</span>(<span class="mxinfo " id="T18:U326">:</span>,<span class="mxinfo " id="T18:U327">:</span>,<span class="var type1" id="S36T3U471">J</span>)</span>, <span class="mxinfo " id="T33:U329"><span class="var type1" id="S16T12U473">whHinf</span>(<span class="mxinfo " id="T18:U331">:</span>,<span class="mxinfo " id="T26:U332">:</span>,<span class="var type1" id="S36T3U476">J</span>)</span>, <span class="var type1" id="S6T3U477">q</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,108" id="srcline108">108</a></span><span class="line">        <span class="comment">%[H,~,Pt1,wh1]   = HinfFilter_COP_v1_PRT_RT_Motion_mex(indat(i,:), Vv, gamma, Pt1, wh1, q);</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,109" id="srcline109">109</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,110" id="srcline110">110</a></span><span class="line">    <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,111" id="srcline111">111</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,112" id="srcline112">112</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,113" id="srcline113">113</a></span><span class="line"><span class="comment">%% Output</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,114" id="srcline114">114</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,115" id="srcline115">115</a></span><span class="line"><span class="mxinfo " id="T1:U335"><span class="var type1" id="S2T1U480">outData</span> = <span class="mxinfo " id="T1:U337"><span class="var type1" id="S17T13U482">cleanData</span>(<span class="mxinfo " id="T19:U339">:</span>,<span class="mxinfo " id="T26:U340">:</span>,<span class="mxinfo " id="T3:U341">end</span>)</span></span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,116" id="srcline116">116</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,117" id="srcline117">117</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,118" id="srcline118">118</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,119" id="srcline119">119</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,120" id="srcline120">120</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,121" id="srcline121">121</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,122" id="srcline122">122</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,123" id="srcline123">123</a></span><span class="line"></span></span>
</pre>
